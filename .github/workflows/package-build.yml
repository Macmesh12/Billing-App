name: Build Electron packages

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Install system deps for PyInstaller/WeasyPrint
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-venv build-essential libpango-1.0-0 libcairo2 libgdk-pixbuf2.0-0 libffi7 libjpeg-dev libpng-dev

      - name: Build backend binary (PyInstaller)
        run: |
          python3 --version
          bash backend/scripts/build_pyinstaller.sh

      - name: Copy backend artifacts into electron packaging folder
        run: |
          rm -rf electron/backend_dist
          mkdir -p electron/backend_dist
          # Copy the PyInstaller onedir build
          if [ -d backend/dist/billing-backend ]; then
            cp -r backend/dist/billing-backend/* electron/backend_dist/
          elif [ -d dist/billing-backend ]; then
            cp -r dist/billing-backend/* electron/backend_dist/
          fi
          # Include the compiled frontend so Django can serve it from the packaged location
          rm -rf electron/backend_dist/static_build
          cp -r frontend/dist electron/backend_dist/static_build

      - name: Install electron deps
        working-directory: ./electron
        run: |
          npm ci

      - name: Package (deb)
        working-directory: ./electron
        run: |
          npm run package:linux

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-linux-artifacts
          path: ./electron/dist

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        working-directory: ./frontend
        shell: bash
        run: |
          npm ci
          npm run build

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Build backend binary (PyInstaller for Windows)
        shell: pwsh
        run: |
          Write-Host "Python version: $(python --version)"
          pwsh -NoProfile -ExecutionPolicy Bypass -File backend/scripts/build_pyinstaller_windows.ps1

      - name: Copy backend artifacts into electron packaging folder (Windows)
        shell: pwsh
        run: |
          if (Test-Path electron\backend_dist) { Remove-Item -Recurse -Force electron\backend_dist }
          New-Item -ItemType Directory -Path electron\backend_dist | Out-Null
          if (Test-Path backend\dist\billing-backend) {
            Copy-Item -Recurse -Force backend\dist\billing-backend\* electron\backend_dist\
          } elseif (Test-Path dist\billing-backend) {
            Copy-Item -Recurse -Force dist\billing-backend\* electron\backend_dist\
          }
          # include frontend build
          if (Test-Path electron\backend_dist\static_build) { Remove-Item -Recurse -Force electron\backend_dist\static_build }
          Copy-Item -Recurse -Force frontend\dist electron\backend_dist\static_build

      - name: Install electron deps
        working-directory: ./electron
        run: |
          npm ci

      - name: Package (nsis)
        working-directory: ./electron
        run: |
          npm run package:win

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-windows-artifacts
          path: ./electron/dist

  publish-release:
    name: Create GitHub Release and upload installers
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-linux-artifacts
          path: release_artifacts/linux

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-windows-artifacts
          path: release_artifacts/windows

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ github.run_number }}
          release_name: Billing App ${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload installers to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
        run: |
          set -euo pipefail
          echo "Uploading files from release_artifacts/* to release: $UPLOAD_URL"
          for f in $(find release_artifacts -type f -maxdepth 4); do
            fname=$(basename "$f")
            echo "Uploading $f as $fname"
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$f" "${UPLOAD_URL}?name=${fname}"
          done

  smoke-test-linux:
    name: Smoke test Linux .deb
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
      - name: Download Linux packaging artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-linux-artifacts
          path: smoke/linux

      - name: Install runtime deps for smoke test
        run: |
          sudo apt-get update
          sudo apt-get install -y libpango-1.0-0 libcairo2 libgdk-pixbuf2.0-0 libffi7 libjpeg-dev libpng-dev curl

      - name: Extract .deb and locate backend binary
        run: |
          set -euo pipefail
          DEB=$(find smoke/linux -type f -name '*.deb' | head -n 1)
          if [ -z "$DEB" ]; then echo "No .deb found in artifacts"; ls -la smoke/linux; exit 1; fi
          mkdir -p smoke/extract
          cd smoke/extract
          ar x "$DEB"
          # extract data.tar.* which contains the filesystem layout
          DATA_TAR=$(ls | grep '^data.tar' | head -n1)
          if [ -z "$DATA_TAR" ]; then echo "data.tar.* not found in deb"; exit 1; fi
          tar -xf "$DATA_TAR"
          # find the bundled backend binary
          BIN=$(find . -type f -name billing-backend -print | head -n1 || true)
          if [ -z "$BIN" ]; then echo "Bundled backend binary not found"; find . -type f | sed -n '1,200p'; exit 1; fi
          echo "Found backend binary: $BIN"
          # Make executable
          chmod +x "$BIN"
          # Print some context for debugging
          ls -la "$(dirname "$BIN")"
          echo "BIN_DIR=$(dirname $BIN)" >> $GITHUB_ENV

      - name: Start bundled backend and wait for readiness
        run: |
          set -euo pipefail
          echo "Using BIN_DIR: $BIN_DIR"
          # Start backend in background
          echo "Starting backend from $BIN_DIR"
          (cd "$BIN_DIR" && ./billing-backend --runserver 127.0.0.1:8765) &
          BG_PID=$!
          echo "Backend pid: $BG_PID"
          # Wait for server ready
          for i in $(seq 1 30); do
            if curl -sSf http://127.0.0.1:8765/ >/dev/null 2>&1; then
              echo "Backend responded"
              break
            fi
            sleep 1
          done
          # Check final status
          if ! curl -sSf http://127.0.0.1:8765/ >/dev/null 2>&1; then
            echo "Backend did not respond within timeout"; ps aux | head -n 200; exit 1
          fi
          # Stop backend
          kill $BG_PID || true
          wait $BG_PID || true
          echo "Smoke test passed: backend started and responded"
